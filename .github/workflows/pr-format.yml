name: pr-format

on:
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]

permissions:
  pull-requests: write
  issues: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  enforce:
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR description
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const title = context.payload.pull_request.title || '';
            const body = context.payload.pull_request.body || '';

            const requirements = [
              { name: 'PR title follows [AREA] format', check: /^\[.+\]\s.+/.test(title) },
              {
                name: 'Summary provided',
                check: /## ðŸ“‹ Summary\s+[^<\s]/.test(body) &&
                       !body.includes('<!-- Provide a brief summary of your changes -->')
              },
              {
                name: 'Type of change selected',
                check: /## ðŸŽ¯ Type of Change[\s\S]*- \[[xX]\]/.test(body)
              },
              {
                name: 'What Changed section present',
                check: /## ðŸ” What Changed[\s\S]*?### Core Changes[\s\S]*?### Files Modified/.test(body)
              },
              {
                name: 'Testing section completed',
                check: /## ðŸ§ª Testing[\s\S]*- \[[xX]\]/.test(body) &&
                       !body.includes('# Paste relevant test output here')
              },
              {
                name: 'Documentation section present',
                check: /## ðŸ“– Documentation/.test(body)
              },
              {
                name: 'Related issues section present',
                check: /## ðŸ”— Related Issues/.test(body)
              },
              {
                name: 'Screenshots section present',
                check: /## ðŸ“¸ Screenshots\/Recordings/.test(body)
              },
              {
                name: 'Deployment notes section present',
                check: /## ðŸš€ Deployment Notes[\s\S]*?### Environment Variables[\s\S]*?### Database Changes[\s\S]*?### Configuration Changes/.test(body)
              },
              {
                name: 'Security testing completed',
                check: /### Security Testing[\s\S]*- \[[xX]\]/.test(body)
              },
              {
                name: 'Pre-submission checklist completed',
                check: /## âœ… Pre-submission Checklist[\s\S]*- \[[xX]\]/.test(body)
              },
              {
                name: 'Reviewer guidance section present',
                check: /## ðŸ‘¥ Reviewer Guidance/.test(body) &&
                       /### Focus Areas/.test(body) &&
                       /### Questions for Reviewers/.test(body)
              },
              {
                name: 'Post-merge tasks section present',
                check: /## ðŸƒâ€â™‚ï¸ Post-Merge Tasks/.test(body)
              }
            ];

            const missing = requirements.filter(req => !req.check);

            if (missing.length > 0) {
              const comment = `## âš ï¸ PR Requirements Check\n\nThe following requirements are missing from your PR:\n\n${missing.map(req => `- âŒ ${req.name}`).join('\n')}\n\nPlease update your PR description to include all required sections.\n\nSee the [PR template](.github/pull_request_template.md) for guidance.`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: comment,
              });

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pull_number,
                labels: ['needs-info'],
              });

              core.setFailed(`Missing PR requirements: ${missing.map(req => req.name).join(', ')}`);
            }
