# @cortex-os/observability

Utilities for structured logging, metrics, and tracing with ULID propagation for Cortex-OS services.

## Adoption metrics

The observability stack now tracks exporter coverage across core and supporting services. The JSON source of truth lives in
`reports/observability-adoption.json` and is regenerated by `pnpm audit:observability` in CI (`quality-gates` workflow) and via the
`posttest` hook. SLO owners can correlate these results with the service expectations documented in
[`docs/performance-monitoring.md`](../../docs/performance-monitoring.md#observability-adoption-coverage).

| Service | Exporter Type | Telemetry Status | Verification Timestamp |
| --- | --- | --- | --- |
| Memory API | OpenTelemetry | ✅ Enabled (CI required) | 2025-10-16T10:05:22Z |
| Agent Health Monitor | OpenTelemetry (planned) | ❌ Disabled | 2025-10-16T10:05:22Z |
| Data Pipeline | Prometheus (planned) | ❌ Disabled | 2025-10-16T10:05:22Z |
| ML Inference | OpenTelemetry (planned) | ❌ Disabled | 2025-10-16T10:05:22Z |
| Scaphandre Bridge | Custom (planned) | ❌ Disabled | 2025-10-16T10:05:22Z |

> **Note:** Required services must remain at 100% coverage; CI fails if any `required: true` entry in
> `configs/observability/services.json` lacks an `otel.*`, `@opentelemetry`, or `nx.telemetry.*` signal.

## Exporters

`initializeObservability(serviceName)` configures OpenTelemetry with exporters selected via environment variables:

- `TRACE_EXPORTER`: `otlp` (default), `jaeger`, or `console`
- `METRIC_EXPORTER`: `otlp` (default) or `console`

## Local viewer

For local development, `startConsoleViewer(serviceName)` emits spans and metrics to the console using the console exporters.

## CI audit

`pnpm audit:observability` re-scans configured services for instrumentation markers (`otel.*`, `@opentelemetry`, or
`nx.telemetry.*`) and writes a machine-readable report to `reports/observability-adoption.json`.
The quality gates workflow runs the audit so that missing exporters block merges instead of hiding behind postmortems.

## Flamegraphs

`generateFlamegraph(entry, outputDir)` runs [`0x`](https://www.npmjs.com/package/0x) via `npx`
to generate an HTML CPU flamegraph for a Node.js script.
