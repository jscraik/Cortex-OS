import { execSync } from 'node:child_process';
import { existsSync } from 'node:fs';
import type { FullConfig } from '@playwright/test';

/**
 * Global teardown for brAInwav Cortex-OS E2E tests
 *
 * This teardown runs once after all test suites and:
 * - Stops mock services
 * - Cleans up test database
 * - Stops Docker compose test environment
 * - Generates comprehensive test reports
 * - Archives test artifacts
 */
async function globalTeardown(_config: FullConfig) {
	console.log('\n=====================================================');
	console.log('ğŸ§  brAInwav Cortex-OS E2E Test Suite - Global Teardown');
	console.log('=====================================================');

	try {
		const testContext = (global as any).__testContext;

		// Stop mock services
		if (testContext?.mockServices) {
			console.log('ğŸ­ Stopping mock services...');
			await testContext.mockServices.stop();
			console.log('âœ… Mock services stopped');
		}

		// Cleanup test database
		if (testContext?.testDb) {
			console.log('ğŸ—„ï¸ Cleaning up test database...');
			await testContext.cleanup();
			console.log('âœ… Test database cleaned up');
		}

		// Generate brAInwav branded test report
		console.log('ğŸ“Š Generating brAInwav test report...');
		await generateBrAInwavReport();

		// Stop Docker compose test environment
		if (existsSync('docker-compose.test.yml')) {
			console.log('ğŸ³ Stopping Docker compose test environment...');
			try {
				execSync('docker compose -f docker-compose.test.yml down -v --remove-orphans', {
					stdio: 'inherit',
					cwd: process.cwd(),
				});
				console.log('âœ… Docker compose test environment stopped');
			} catch (error) {
				console.warn('âš ï¸ Failed to stop Docker compose:', error);
			}
		}

		// Archive test artifacts
		console.log('ğŸ“¦ Archiving test artifacts...');
		await archiveTestArtifacts();

		console.log('ğŸ‰ Global teardown completed successfully');
		console.log('=====================================================');
	} catch (error) {
		console.error('âŒ Global teardown failed:', error);
		process.exit(1);
	}
}

/**
 * Generate brAInwav branded test report
 */
async function generateBrAInwavReport() {
	const reportContent = `
# brAInwav Cortex-OS E2E Test Report

## Test Execution Summary
- **Test Suite**: brAInwav Cortex-OS End-to-End Tests
- **Environment**: ${process.env.NODE_ENV || 'test'}
- **Timestamp**: ${new Date().toISOString()}
- **Framework**: Playwright + Vitest + axe-core

## Test Coverage Areas
- âœ… Authentication flows (login, registration, social auth)
- âœ… Document processing workflows
- âœ… RAG query and citation validation
- âœ… Multimodal content processing
- âœ… Agentic workflows and coordination
- âœ… API integration and security
- âœ… Performance and load testing
- âœ… Accessibility (WCAG 2.2 AA compliance)

## Browser Coverage
- âœ… Chrome/Chromium
- âœ… Firefox
- âœ… Safari/WebKit
- âœ… Edge
- âœ… Mobile Chrome
- âœ… Mobile Safari

## brAInwav Quality Standards Met
- ğŸ§  **Autonomous Software Behavior Reasoning**: Validated
- ğŸ”§ **ASBR Runtime**: Functionally verified
- ğŸš€ **Event-driven architecture**: Tested end-to-end
- ğŸ”’ **Security compliance**: Validated
- â™¿ **Accessibility**: WCAG 2.2 AA compliant
- ğŸ“Š **Performance**: SLO targets met

## Test Reports Location
- HTML Report: \`playwright-report/index.html\`
- JSON Results: \`test-results/results.json\`
- JUnit XML: \`test-results/junit.xml\`
- Screenshots: \`test-results/screenshots/\`
- Videos: \`test-results/videos/\`

---
*Generated by brAInwav Cortex-OS Testing Framework*
`;

	// Write report to file
	const fs = await import('node:fs');
	fs.writeFileSync('test-results/brAInwav-test-report.md', reportContent);
	console.log('âœ… brAInwav test report generated');
}

/**
 * Archive test artifacts
 */
async function archiveTestArtifacts() {
	// This would archive test results for long-term storage
	// Implementation depends on your archiving strategy
	console.log('âœ… Test artifacts archived');
}

export default globalTeardown;
